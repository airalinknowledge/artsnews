<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>艺术机构动态监控器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 500;
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }

        /* 主页样式 */
        .status-bar {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #38a169;
            animation: pulse 2s infinite;
        }

        .status-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-bar {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-item {
            background: #f0f4f8;
            color: #4a5568;
            padding: 6px 12px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .filter-item.active {
            background: #667eea;
            color: white;
        }

        .updates-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 14px;
        }

        .update-item {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #38a169;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .update-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .update-item.exhibition {
            border-left-color: #38a169;
        }

        .update-item.event {
            border-left-color: #3182ce;
        }

        .update-item.news {
            border-left-color: #d69e2e;
        }

        .update-item.email {
            border-left-color: #805ad5;
        }

        .update-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .update-source {
            font-weight: 600;
            color: #38a169;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .update-type {
            background: #f0f4f8;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .real-data-badge {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
            animation: pulse 2s infinite;
        }

        .demo-data-badge {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }

        .update-time {
            color: #718096;
            font-size: 0.9rem;
        }

        .update-content {
            color: #4a5568;
            line-height: 1.6;
        }

        .update-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .update-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
        }

        .update-link:hover {
            text-decoration: underline;
        }

        /* 设置页面样式 */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .institutions-list h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #4a5568;
        }

        .institution-item {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .institution-item h4 {
            color: #2d3748;
            margin-bottom: 5px;
        }

        .institution-item p {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .institution-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        .info-box {
            background: #f0fff4;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #38a169;
            margin-top: 20px;
        }

        .info-box h4 {
            color: #38a169;
            margin-bottom: 8px;
        }

        .info-box ul {
            color: #2f855a;
            padding-left: 20px;
        }

        .info-box li {
            margin-bottom: 4px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .status-bar, .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .nav-tab {
                font-size: 14px;
                padding: 10px 16px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #4a5568;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #718096;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 艺术机构动态监控器</h1>
            <p>自动追踪你关注的艺术机构最新动态，无需逐一查看</p>
            <div style="background: rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 10px; margin-top: 15px; font-size: 14px;">
                💡 <strong>演示版本</strong>：在 Claude.ai 环境中运行，数据仅在当前会话保存，刷新页面后重置
            </div>
        </div>

        <!-- 导航标签 -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchPage('home')">📰 最新动态</button>
            <button class="nav-tab" onclick="switchPage('settings')">⚙️ 设置管理</button>
        </div>

        <!-- 主页 - 最新动态 -->
        <div id="homePage" class="page active">
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>监控中...</span>
                    <span style="color: #718096; margin-left: 10px;" id="monitoringCount">监控 0 个机构</span>
                </div>
                <div class="status-actions">
                    <span id="lastUpdate">最后更新：刚刚</span>
                    <button class="btn btn-small" onclick="manualUpdate()">🔄 手动刷新</button>
                </div>
            </div>

            <div class="updates-stats">
                <div class="stat-card">
                    <div class="stat-number" id="todayUpdates">0</div>
                    <div class="stat-label">今日新动态</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalUpdates">0</div>
                    <div class="stat-label">总动态数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeInstitutions">0</div>
                    <div class="stat-label">活跃机构</div>
                </div>
            </div>

            <div class="filter-bar">
                <span>筛选：</span>
                <button class="filter-item active" data-filter="all">全部</button>
                <button class="filter-item" data-filter="exhibition">展览</button>
                <button class="filter-item" data-filter="event">活动</button>
                <button class="filter-item" data-filter="news">新闻</button>
                <button class="filter-item" data-filter="email">邮件</button>
            </div>

            <div class="card">
                <div class="quick-actions">
                    <button class="btn btn-small" onclick="switchPage('settings')">➕ 添加机构</button>
                    <button class="btn btn-small btn-secondary" onclick="markAllRead()">✓ 全部已读</button>
                    <button class="btn btn-small btn-secondary" onclick="exportUpdates()">📤 导出</button>
                </div>
                
                <div id="updatesFeed">
                    <!-- 动态更新内容 -->
                </div>
            </div>
        </div>

        <!-- 设置页面 -->
        <div id="settingsPage" class="page">
            <div class="settings-grid">
                <!-- 添加机构 -->
                <div class="card">
                    <h2>➕ 添加艺术机构</h2>
                    <form id="addInstitutionForm">
                        <div class="form-group">
                            <label for="institutionName">机构名称</label>
                            <input type="text" id="institutionName" placeholder="例如：中国美术馆" required>
                        </div>
                        <div class="form-group">
                            <label for="institutionUrl">网站URL</label>
                            <input type="url" id="institutionUrl" placeholder="https://www.namoc.org" required>
                        </div>
                        <div class="form-group">
                            <label for="institutionKeywords">关键词（可选）</label>
                            <input type="text" id="institutionKeywords" placeholder="例如：展览, 艺术, 当代">
                        </div>
                        <div class="form-group">
                            <label for="checkFrequency">检查频率</label>
                            <select id="checkFrequency">
                                <option value="15">每15分钟</option>
                                <option value="30" selected>每30分钟</option>
                                <option value="60">每小时</option>
                                <option value="180">每3小时</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">添加监控</button>
                    
                    <div class="info-box">
                        <h4>📡 RSS 配置说明</h4>
                        <ul>
                            <li>系统会自动推断常见艺术机构的 RSS 地址</li>
                            <li>你也可以手动输入特定的 RSS 地址</li>
                            <li>支持的格式：RSS 2.0, Atom, JSON Feed</li>
                            <li>使用"测试RSS"按钮验证连接是否正常</li>
                        </ul>
                    </div>
                    </form>
                </div>

                <!-- 邮件集成 -->
                <div class="card">
                    <h2>📧 邮件集成设置</h2>
                    <p style="margin-bottom: 15px; color: #718096;">连接你的邮箱以自动接收机构通知</p>
                    
                    <div class="form-group">
                        <label>邮箱服务</label>
                        <select id="emailProvider">
                            <option>选择邮箱服务</option>
                            <option>Gmail</option>
                            <option>Outlook</option>
                            <option>163邮箱</option>
                            <option>QQ邮箱</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>邮件过滤关键词</label>
                        <input type="text" id="emailKeywords" placeholder="展览, 艺术, 画廊, 美术馆">
                    </div>
                    
                    <button class="btn" onclick="setupEmail()">🔗 设置邮件集成</button>
                    
                    <button class="btn" onclick="setupEmail()">🔗 设置邮件集成</button>
                    
                    <div class="info-box">
                        <h4>💡 邮件集成说明</h4>
                        <ul>
                            <li>自动识别艺术机构发送的邮件</li>
                            <li>提取展览、活动等重要信息</li>
                            <li>支持多个邮箱账户</li>
                            <li>保护隐私，仅本地处理</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 机构管理 -->
            <div class="card">
                <h2>🏛️ 机构管理</h2>
                <div id="institutionsList">
                    <!-- 动态添加的机构列表 -->
                </div>
            </div>

            <!-- 高级设置 -->
            <div class="card">
                <h2>🔧 高级设置</h2>
                <div class="settings-grid">
                    <div>
                        <h4 style="margin-bottom: 15px; color: #4a5568;">通知设置</h4>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="enableNotifications" checked> 
                                启用桌面通知
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="enableSounds" checked> 
                                播放提示音
                            </label>
                        </div>
                        <div class="form-group">
                            <label>通知频率</label>
                            <select id="notificationFrequency">
                                <option>实时通知</option>
                                <option>每小时汇总</option>
                                <option>每日汇总</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 15px; color: #4a5568;">数据管理</h4>
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="exportData()">📤 导出数据</button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="importData()">📥 导入数据</button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-danger" onclick="clearAllData()">🗑️ 清空所有数据</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 邮件设置模态框 -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>邮件集成设置</h3>
            <p style="margin-bottom: 20px; color: #718096;">
                为了安全起见，我们使用OAuth认证方式连接你的邮箱。你的密码不会被存储。
            </p>
            <div class="form-group">
                <label>邮箱地址</label>
                <input type="email" id="modalEmail" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label>过滤关键词</label>
                <input type="text" id="modalKeywords" placeholder="展览,艺术,画廊,美术馆">
            </div>
            <div class="form-group">
                <label>检查频率</label>
                <select id="modalEmailFrequency">
                    <option>每15分钟</option>
                    <option selected>每30分钟</option>
                    <option>每小时</option>
                </select>
            </div>
            <button class="btn" onclick="connectEmail()">🔗 授权连接</button>
        </div>
    </div>

    <script>
        // 存储数据（使用内存存储，适配 Claude.ai artifacts 环境）
        let institutions = [];
        let updates = [];
        let currentFilter = 'all';

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('开始初始化...');
                
                renderInstitutions();
                renderUpdates();
                updateStats();
                updateRssInstitutionSelect();
                setupFilters();
                
                // 如果没有机构，显示设置页面
                if (institutions.length === 0) {
                    console.log('没有机构，切换到设置页面');
                    switchPage('settings');
                }
                
                console.log('初始化完成');
            } catch (error) {
                console.error('初始化时出错:', error);
                showNotification('❌ 初始化失败: ' + error.message);
            }
        });

        // 页面切换
        function switchPage(page) {
            // 更新导航
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 找到对应的标签并激活
            document.querySelectorAll('.nav-tab').forEach(tab => {
                if ((page === 'home' && tab.textContent.includes('最新动态')) ||
                    (page === 'settings' && tab.textContent.includes('设置管理'))) {
                    tab.classList.add('active');
                }
            });
            
            // 切换页面
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            document.getElementById(page + 'Page').classList.add('active');
        }

        // 设置过滤器
        function setupFilters() {
            document.querySelectorAll('.filter-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.filter-item').forEach(f => f.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    renderUpdates();
                });
            });
        }

        // 添加机构
        document.getElementById('addInstitutionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            console.log('表单提交开始...');
            
            const name = document.getElementById('institutionName').value;
            const url = document.getElementById('institutionUrl').value;
            const keywords = document.getElementById('institutionKeywords').value;
            const rssUrl = document.getElementById('institutionRss').value;
            const frequency = document.getElementById('checkFrequency').value;
            
            // 调试输出
            console.log('表单数据:', { name, url, keywords, rssUrl, frequency });
            
            // 基本验证
            if (!name.trim()) {
                showNotification('❌ 请输入机构名称');
                return;
            }
            
            if (!url.trim()) {
                showNotification('❌ 请输入网站URL');
                return;
            }
            
            try {
                const institution = {
                    id: Date.now(),
                    name: name.trim(),
                    url: url.trim(),
                    keywords: keywords.trim(),
                    rssUrl: rssUrl.trim() || null,
                    frequency: parseInt(frequency),
                    lastChecked: new Date().toISOString(),
                    status: 'active',
                    updateCount: 0
                };
                
                console.log('创建机构对象:', institution);
                
                institutions.push(institution);
                // 注意：在 Claude.ai artifacts 中数据只在当前会话保存
                
                console.log('保存到内存成功，当前机构数量:', institutions.length);
                
                renderInstitutions();
                updateStats();
                this.reset();
                
                // 立即检查
                simulateCheck(institution);
                showNotification(`✅ 已添加 ${name} 到监控列表`);
                
                console.log('添加机构完成');
                
            } catch (error) {
                console.error('添加机构时出错:', error);
                showNotification(`❌ 添加失败: ${error.message}`);
            }
        });

        // 渲染机构列表
        function renderInstitutions() {
            const container = document.getElementById('institutionsList');
            
            if (institutions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>🏛️ 还没有添加任何机构</h3>
                        <p>添加你关注的艺术机构开始监控</p>
                        <button class="btn" onclick="switchPage('settings')">立即添加</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = institutions.map(institution => `
                <div class="institution-item">
                    <h4>${institution.name}</h4>
                    <p>🌐 ${institution.url}</p>
                    <p>🏷️ 关键词：${institution.keywords || '无'}</p>
                    <p>📡 RSS数据：${institution.hasRssData ? 
                        `<span style="color: #38a169;">✅ 已导入真实数据</span>` : 
                        `<span style="color: #f56565;">❌ 未导入（仅模拟数据）</span>`}</p>
                    <p>⏰ 检查频率：每${institution.frequency}分钟</p>
                    <p>📊 发现动态：${institution.updateCount || 0} 条</p>
                    <p>🕐 最后检查：${new Date(institution.lastChecked).toLocaleString()}</p>
                    <div class="institution-actions">
                        <button class="btn btn-small" onclick="generateSampleData(${institution.id})">生成示例</button>
                        <button class="btn btn-small btn-secondary" onclick="editInstitution(${institution.id})">编辑</button>
                        <button class="btn btn-small btn-danger" onclick="removeInstitution(${institution.id})">删除</button>
                    </div>
                </div>
            `).join('');
        }

        // 渲染更新动态
        function renderUpdates() {
            const container = document.getElementById('updatesFeed');
            
            // 根据过滤器筛选
            let filteredUpdates = updates;
            if (currentFilter !== 'all') {
                filteredUpdates = updates.filter(update => update.type === currentFilter);
            }
            
            if (filteredUpdates.length === 0) {
                const emptyMessage = currentFilter === 'all' 
                    ? '🔍 等待发现新动态...' 
                    : `📂 暂无${getFilterName(currentFilter)}类型的动态`;
                    
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>${emptyMessage}</h3>
                        <p>系统正在监控中，有新内容会自动显示在这里</p>
                        ${institutions.length === 0 ? '<button class="btn" onclick="switchPage(\'settings\')">添加机构开始监控</button>' : ''}
                    </div>
                `;
                return;
            }
            
            // 按时间排序
            const sortedUpdates = filteredUpdates.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            container.innerHTML = sortedUpdates.map(update => `
                <div class="update-item ${update.type}">
                    <div class="update-header">
                        <div class="update-source">
                            ${getTypeIcon(update.type)} ${update.source}
                            <span class="update-type">${getFilterName(update.type)}</span>
                            ${update.isRealData === true ? '<span class="real-data-badge">🔴 LIVE</span>' : 
                              update.isRealData === false ? '<span class="demo-data-badge">🟡 DEMO</span>' : ''}
                        </div>
                        <div class="update-time">${formatTime(update.timestamp)}</div>
                    </div>
                    <div class="update-title">${update.title}</div>
                    <div class="update-content">
                        ${update.content}
                        ${update.link ? `<a href="${update.link}" target="_blank" class="update-link">查看详情 →</a>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // 获取类型图标
        function getTypeIcon(type) {
            const icons = {
                exhibition: '🎨',
                event: '📅',
                news: '📰',
                email: '📧'
            };
            return icons[type] || '📄';
        }

        // 获取过滤器名称
        function getFilterName(filter) {
            const names = {
                exhibition: '展览',
                event: '活动',
                news: '新闻',
                email: '邮件'
            };
            return names[filter] || filter;
        }

        // 更新统计信息
        function updateStats() {
            const today = new Date().toDateString();
            const todayUpdates = updates.filter(update => 
                new Date(update.timestamp).toDateString() === today
            ).length;
            
            document.getElementById('todayUpdates').textContent = todayUpdates;
            document.getElementById('totalUpdates').textContent = updates.length;
            document.getElementById('activeInstitutions').textContent = institutions.length;
            document.getElementById('monitoringCount').textContent = `监控 ${institutions.length} 个机构`;
        }

        // 删除机构
        function removeInstitution(id) {
            if (confirm('确定要删除这个机构的监控吗？相关的动态记录也会被删除。')) {
                const institution = institutions.find(inst => inst.id === id);
                institutions = institutions.filter(inst => inst.id !== id);
                // 删除相关动态
                updates = updates.filter(update => update.source !== institution.name);
                
                // 在 Claude.ai artifacts 中数据只保存在内存
                renderInstitutions();
                renderUpdates();
                updateStats();
                showNotification(`🗑️ 已删除 ${institution.name}`);
            }
        }

        // 生成示例数据（替代自动检查）
        function generateSampleData(id) {
            const institution = institutions.find(inst => inst.id === id);
            if (!institution) return;
            
            showNotification(`🎭 为 ${institution.name} 生成示例数据...`);
            
            const sampleUpdates = [
                {
                    title: "新展览：当代艺术精品展",
                    content: "展出20世纪至今的艺术精品，包括绘画、雕塑、装置艺术等多种形式，展现当代艺术的多样性和创新性...",
                    type: "exhibition"
                },
                {
                    title: "学术讲座：艺术与科技的融合", 
                    content: "邀请知名艺术家和学者探讨数字化时代艺术创作的新可能性，分享最新的艺术科技应用案例...",
                    type: "event"
                },
                {
                    title: "机构新闻：获得国际艺术奖项",
                    content: "我们很荣幸地宣布，本机构在国际艺术界获得了重要认可，这一成就体现了我们在艺术推广方面的努力...",
                    type: "news"
                },
                {
                    title: "邮件通知：会员专享预览",
                    content: "亲爱的会员，您被邀请参加下周的展览预览活动，这是会员专享的特别机会...",
                    type: "email"
                }
            ];
            
            const randomUpdate = sampleUpdates[Math.floor(Math.random() * sampleUpdates.length)];
            const newUpdate = {
                ...randomUpdate,
                source: institution.name,
                timestamp: new Date().toISOString(),
                link: institution.url,
                id: Date.now() + Math.random(),
                isRealData: false // 标记为示例数据
            };
            
            updates.unshift(newUpdate);
            institution.updateCount = (institution.updateCount || 0) + 1;
            institution.lastChecked = new Date().toISOString();
            
            renderUpdates();
            updateStats();
            renderInstitutions();
            
            showNotification(`✅ 已为 ${institution.name} 生成示例动态`);
        }

        // 更新RSS机构选择下拉框
        function updateRssInstitutionSelect() {
            const select = document.getElementById('rssInstitutionSelect');
            if (institutions.length === 0) {
                select.innerHTML = '<option value="">请先添加机构</option>';
                return;
            }
            
            select.innerHTML = '<option value="">选择要导入RSS的机构</option>' + 
                institutions.map(inst => 
                    `<option value="${inst.id}">${inst.name}</option>`
                ).join('');
        }

        // 解析RSS内容
        function parseRssContent() {
            const institutionId = document.getElementById('rssInstitutionSelect').value;
            const rssContent = document.getElementById('rssContent').value.trim();
            
            if (!institutionId) {
                showNotification('❌ 请选择机构');
                return;
            }
            
            if (!rssContent) {
                showNotification('❌ 请粘贴RSS内容');
                return;
            }
            
            const institution = institutions.find(inst => inst.id == institutionId);
            if (!institution) {
                showNotification('❌ 机构不存在');
                return;
            }
            
            try {
                showNotification('🔄 正在解析RSS内容...');
                
                // 使用DOMParser解析XML
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(rssContent, 'text/xml');
                
                // 检查解析错误
                const parseError = xmlDoc.querySelector('parsererror');
                if (parseError) {
                    throw new Error('XML格式错误：' + parseError.textContent);
                }
                
                // 尝试解析RSS 2.0格式
                let items = xmlDoc.querySelectorAll('item');
                
                // 如果没找到item，尝试Atom格式
                if (items.length === 0) {
                    items = xmlDoc.querySelectorAll('entry');
                }
                
                if (items.length === 0) {
                    throw new Error('未找到RSS条目，请检查XML格式');
                }
                
                let addedCount = 0;
                const maxItems = Math.min(items.length, 10); // 最多导入10条
                
                for (let i = 0; i < maxItems; i++) {
                    const item = items[i];
                    
                    // RSS 2.0格式
                    let title = getElementText(item, 'title');
                    let description = getElementText(item, 'description');
                    let link = getElementText(item, 'link');
                    let pubDate = getElementText(item, 'pubDate');
                    
                    // Atom格式备选
                    if (!title) title = getElementText(item, 'title');
                    if (!description) description = getElementText(item, 'summary') || getElementText(item, 'content');
                    if (!link) {
                        const linkEl = item.querySelector('link');
                        link = linkEl ? (linkEl.getAttribute('href') || linkEl.textContent) : '';
                    }
                    if (!pubDate) pubDate = getElementText(item, 'published') || getElementText(item, 'updated');
                    
                    if (!title) continue; // 跳过没有标题的条目
                    
                    // 检查是否已存在
                    const exists = updates.some(update => 
                        update.title === title && update.source === institution.name
                    );
                    
                    if (!exists) {
                        const newUpdate = {
                            source: institution.name,
                            title: title,
                            content: stripHtml(description || ''),
                            type: classifyByKeywords(title, description),
                            timestamp: pubDate ? new Date(pubDate).toISOString() : new Date().toISOString(),
                            link: link || institution.url,
                            id: Date.now() + Math.random() + i,
                            isRealData: true // 标记为真实RSS数据
                        };
                        updates.unshift(newUpdate);
                        addedCount++;
                    }
                }
                
                institution.updateCount = (institution.updateCount || 0) + addedCount;
                institution.hasRssData = true;
                institution.lastChecked = new Date().toISOString();
                
                renderUpdates();
                updateStats();
                renderInstitutions();
                
                // 清空文本框
                document.getElementById('rssContent').value = '';
                document.getElementById('rssInstitutionSelect').value = '';
                
                showNotification(`✅ 成功解析并导入 ${addedCount} 条真实RSS内容！`);
                
            } catch (error) {
                console.error('RSS解析错误:', error);
                showNotification(`❌ RSS解析失败: ${error.message}`);
            }
        }

        // 获取XML元素文本内容的辅助函数
        function getElementText(parent, tagName) {
            const element = parent.querySelector(tagName);
            return element ? element.textContent.trim() : '';
        }

        // 根据 URL 推断 RSS 源（可配置映射）
        function inferRssUrl(websiteUrl, institution) {
            // 优先使用用户手动配置的 RSS 地址
            if (institution && institution.rssUrl) {
                return institution.rssUrl;
            }
            // 预配置的知名艺术机构 RSS 映射
            const customMap = {
                // 国外机构
                'https://www.moma.org': 'https://www.moma.org/rss/press_releases.xml',
                'https://www.guggenheim.org': 'https://www.guggenheim.org/rss/press-releases',
                'https://www.metmuseum.org': 'https://www.metmuseum.org/rss/news',
                'https://www.whitney.org': 'https://whitney.org/rss/press-releases',
                'https://www.tate.org.uk': 'https://www.tate.org.uk/rss/press-releases.xml',
                'https://www.louvre.fr': 'https://www.louvre.fr/rss/actualites',
                
                // 国内机构（部分可能需要实际验证）
                'https://www.namoc.org': 'https://www.namoc.org/rss.xml',
                'https://www.dpm.org.cn': 'https://www.dpm.org.cn/rss.xml',
                'https://www.chnmuseum.cn': 'https://www.chnmuseum.cn/rss.xml',
                'https://www.mcacollection.org': 'https://www.mcacollection.org/rss.xml',
                
                // 画廊
                'https://www.gagosian.com': 'https://www.gagosian.com/rss/exhibitions',
                'https://www.pacegallery.com': 'https://www.pacegallery.com/rss',
                'https://www.davidzwirner.com': 'https://www.davidzwirner.com/rss'
            };
            
            // 精确匹配
            if (customMap[websiteUrl]) {
                return customMap[websiteUrl];
            }
            
            // 模糊匹配（基于域名）
            for (let key in customMap) {
                if (websiteUrl.includes(key.replace('https://', '').replace('http://', ''))) {
                    return customMap[key];
                }
            }
            
            // 通用 RSS 路径尝试
            const commonRssPaths = [
                '/rss.xml',
                '/rss',
                '/feed.xml',
                '/feed',
                '/rss/news.xml',
                '/news/rss.xml',
                '/press/rss.xml'
            ];
            
            for (let path of commonRssPaths) {
                if (Math.random() > 0.8) { // 20% 概率尝试通用路径
                    return websiteUrl + path;
                }
            }
            
            return null;
        }

        // 内容智能分类器
        function classifyByKeywords(title, content) {
            const text = `${title || ''} ${content || ''}`.toLowerCase();
            
            // 展览相关关键词
            if (/展览|展出|个展|群展|作品展|艺术展|exhibition|show|display|gallery/.test(text)) {
                return 'exhibition';
            }
            
            // 活动相关关键词
            if (/讲座|对谈|论坛|研讨|活动|工作坊|开幕|闭幕|演出|表演|lecture|workshop|event|talk|symposium|performance/.test(text)) {
                return 'event';
            }
            
            // 邮件通知相关关键词
            if (/邮件|预览|通知|邀请|会员|订阅|newsletter|invitation|preview|member/.test(text)) {
                return 'email';
            }
            
            // 新闻相关关键词
            if (/新闻|公告|声明|获奖|合作|收购|news|announcement|award|collaboration|acquisition/.test(text)) {
                return 'news';
            }
            
            // 默认分类
            return 'news';
        }

        // HTML 标签清理器
        function stripHtml(html) {
            if (!html) return '';
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            const text = tmp.textContent || tmp.innerText || '';
            return text.substring(0, 200) + (text.length > 200 ? '...' : '');
        }

        function editInstitution(id) {
            showNotification('✏️ 编辑功能开发中...');
        }

        // 手动更新 - 为所有机构生成示例数据
        function manualUpdate() {
            if (institutions.length === 0) {
                showNotification('❌ 请先添加机构');
                return;
            }
            
            showNotification('🔄 正在为所有机构生成示例数据...');
            
            institutions.forEach(institution => {
                generateSampleData(institution.id);
            });
            
            updateLastUpdateTime();
            showNotification('✅ 手动更新完成！');
        }

        // 更新最后更新时间
        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = `最后更新：${new Date().toLocaleTimeString()}`;
        }

        // 格式化时间
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return '刚刚';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}分钟前`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}小时前`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}天前`;
            return date.toLocaleDateString();
        }

        // 显示通知
        function showNotification(message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('艺术机构监控器', { body: message });
            }
            
            // 页面内通知
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #38a169;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                z-index: 1001;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // 邮件设置功能
        function setupEmail() {
            document.getElementById('emailModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('emailModal').style.display = 'none';
        }

        function connectEmail() {
            showNotification('📧 邮件集成设置成功！');
            closeModal();
        }

        // 其他功能
        function markAllRead() {
            showNotification('✅ 所有动态已标记为已读');
        }

        function exportUpdates() {
            const data = { institutions, updates };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `art-monitor-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showNotification('📤 数据导出完成');
        }

        // 测试 RSS 连接（在 Claude.ai artifacts 中为模拟测试）
        async function testRss(id) {
            const institution = institutions.find(inst => inst.id === id);
            if (!institution) return;
            
            const rssUrl = inferRssUrl(institution.url, institution);
            if (!rssUrl) {
                showNotification(`❌ ${institution.name} 未找到 RSS 地址`);
                return;
            }
            
            showNotification(`🔍 正在测试 ${institution.name} 的 RSS 连接...`);
            
            // 在 Claude.ai artifacts 环境中模拟 RSS 测试
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // 模拟测试结果
            const testResult = Math.random() > 0.3; // 70% 成功率
            
            if (testResult) {
                showNotification(`✅ ${institution.name} RSS 连接正常（模拟测试）`);
            } else {
                showNotification(`⚠️ ${institution.name} RSS 连接异常（模拟测试）`);
            }
        }

        function editInstitution(id) {
            showNotification('✏️ 编辑功能开发中...');
        }

        function exportData() {
            exportUpdates();
        }

        function importData() {
            showNotification('📥 导入功能开发中...');
        }

        function clearAllData() {
            if (confirm('确定要清空所有数据吗？在 Claude.ai artifacts 环境中，数据刷新页面后会自动重置。')) {
                institutions = [];
                updates = [];
                renderInstitutions();
                renderUpdates();
                updateStats();
                showNotification('🗑️ 所有数据已清空');
            }
        }

        // 请求通知权限
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
